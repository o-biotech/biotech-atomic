name: build

permissions:
  contents: write

on: push

env:
  MainBranch: main
  MainFormat: "${major}.${minor}.${patch}"
  PrereleaseFormat: "${major}.${minor}.${patch}-prerelease${increment}"
  
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
        
      - name: Set variables
        id: vars
        run: |
          echo "currentBranch=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          

      - name: Set version format
        id: versionFormat
        run: |
          if [ "${{ steps.vars.outputs.currentBranch }}" == "${{ env.MainBranch }}" ]
          then
            echo "format='${{ env.MainFormat }}'" >> $GITHUB_OUTPUT\
          else
            echo "format='${{ env.MainFormat }}-${{ steps.vars.outputs.currentBranch }}(increment)'" >> $GITHUB_OUTPUT\
          fi


      - name: Deno Setup
        uses: denoland/setup-deno@v1.1.0
        with:
          deno-version: v1.x.x

      - name: Deno Build
        run: deno task build

      - name: Version
        id: version
        uses: paulhatch/semantic-version@v5.0.2
        with:
          tag_prefix: "v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)"
          version_format: ${{ steps.versionFormat.outputs.format }}
          # namespace: ${{ steps.vars.outputs.currentBranch == env.MainBranch && null || steps.vars.outputs.currentBranch }}
          # bump_each_commit: false
          # search_commit_body: false
          user_format_type: "json"
          enable_prerelease_mode: true

      - name: Tag commit ${{ steps.version.outputs.version }}
        run: |
          git tag v${{ steps.version.outputs.version }} ${{ steps.commit.outputs.commit }}
          git push origin ${{ steps.version.outputs.version }}
          